<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Vendedor | GitHub Auth</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js e dependências para gráficos financeiros -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>
    
    <!-- Font Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        // Aplica o tema escuro antes da página carregar para evitar "flash"
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .screen, .view { transition: opacity 0.3s ease-in-out; }
        .hidden { display: none; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Estilos para a sidebar ativa */
        .sidebar-link.active {
            background-color: #4f46e5;
            color: #ffffff;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        .dark ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #4a5568; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #718096; }

        /* Animação da sidebar */
        #sidebar, #main-content {
            transition: all 0.3s ease-in-out;
        }
        
        /* Toast Notification */
        #toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translate(-50%, 150%);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.3s ease-in-out;
            z-index: 100;
        }
        #toast.show {
            transform: translate(-50%, 0);
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 antialiased">
    
    <!-- Toast Notification Container -->
    <div id="toast"></div>

    <!-- Tela de Carregamento Inicial -->
    <div id="loading-screen" class="fixed inset-0 bg-white dark:bg-gray-900 flex items-center justify-center z-50">
        <div class="flex flex-col items-center text-center p-4">
            <div class="spinner"></div>
            <p id="loading-message" class="mt-4 text-lg font-medium text-gray-600 dark:text-gray-400">Carregando...</p>
        </div>
    </div>

    <!-- Tela de Autenticação (Login e Cadastro) -->
    <div id="auth-screen" class="screen min-h-screen flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8">
            <div class="flex border-b border-gray-200 dark:border-gray-700 mb-6">
                <button id="show-login-btn" class="flex-1 py-3 text-lg font-semibold text-indigo-600 dark:text-indigo-400 border-b-2 border-indigo-600 dark:border-indigo-400 focus:outline-none">Login</button>
                <button id="show-register-btn" class="flex-1 py-3 text-lg font-semibold text-gray-500 dark:text-gray-400 focus:outline-none">Cadastro</button>
            </div>
            
            <form id="login-form">
                <h2 class="text-3xl font-bold text-center text-gray-800 dark:text-white mb-6">Bem-vindo!</h2>
                <div class="mb-4">
                    <input type="email" id="login-email" required class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Email">
                </div>
                <div class="mb-6">
                    <input type="password" id="login-password" required class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Senha">
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-300">Entrar</button>
            </form>

            <form id="register-form" class="hidden">
                 <h2 class="text-3xl font-bold text-center text-gray-800 dark:text-white mb-6">Crie sua Conta</h2>
                 <div class="mb-4">
                    <input type="email" id="register-email" required class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Email">
                </div>
                <div class="mb-6">
                    <input type="password" id="register-password" required minlength="6" class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Senha (mínimo 6 caracteres)">
                </div>
                <button type="submit" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition duration-300">Cadastrar</button>
            </form>
            <p id="auth-error" class="text-red-500 text-center mt-4 min-h-[20px]"></p>
        </div>
    </div>

    <!-- Modal para Registrar Custo de Venda -->
    <div id="expense-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-40 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">Registrar Custo do Produto</h2>
            <p class="text-gray-600 dark:text-gray-400 mb-1">ID do Pedido: <span id="modal-order-id" class="font-semibold text-gray-800 dark:text-white"></span></p>
            <p class="text-gray-600 dark:text-gray-400 mb-4">Produto: <span id="modal-product-name" class="font-semibold text-gray-800 dark:text-white"></span></p>
            <form id="expense-modal-form">
                <div class="mb-4">
                    <label for="expense-amount" class="block text-gray-700 dark:text-gray-300 font-medium mb-2">Valor de Custo (R$)</label>
                    <input type="number" step="0.01" id="expense-amount" required class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Custo do produto">
                </div>
                 <div class="mb-4">
                    <label for="modal-fornecedor" class="block text-gray-700 dark:text-gray-300 font-medium mb-2">Fornecedor</label>
                    <input type="text" id="modal-fornecedor" required class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Nome do fornecedor">
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-expense-btn" class="bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition">Pular</button>
                    <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 transition">Confirmar Custo</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal para Editar Transação -->
    <div id="edit-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-40 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 w-full max-w-lg">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">Editar Transação</h2>
            <form id="edit-modal-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="edit-id">
                <div class="md:col-span-2"><label for="edit-order-id" class="block text-sm font-medium text-gray-700 dark:text-gray-300">ID do Pedido</label><input type="text" id="edit-order-id" required class="mt-1 w-full p-2 bg-gray-100 dark:bg-gray-700 rounded-lg border dark:border-gray-600"></div>
                <div class="md:col-span-2"><label for="edit-product-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nome do Produto</label><input type="text" id="edit-product-name" required class="mt-1 w-full p-2 bg-gray-100 dark:bg-gray-700 rounded-lg border dark:border-gray-600"></div>
                <div><label for="edit-quantity" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Quantidade</label><input type="number" id="edit-quantity" required class="mt-1 w-full p-2 bg-gray-100 dark:bg-gray-700 rounded-lg border dark:border-gray-600"></div>
                <div><label for="edit-amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Valor (R$)</label><input type="number" step="0.01" id="edit-amount" required class="mt-1 w-full p-2 bg-gray-100 dark:bg-gray-700 rounded-lg border dark:border-gray-600"></div>
                <div><label for="edit-feito-por" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Feito Por</label><input type="text" id="edit-feito-por" class="mt-1 w-full p-2 bg-gray-100 dark:bg-gray-700 rounded-lg border dark:border-gray-600"></div>
                <div><label for="edit-fornecedor" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Fornecedor</label><input type="text" id="edit-fornecedor" class="mt-1 w-full p-2 bg-gray-100 dark:bg-gray-700 rounded-lg border dark:border-gray-600"></div>
                <div class="md:col-span-2 flex justify-end space-x-4 mt-4">
                    <button type="button" id="cancel-edit-btn" class="bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition">Cancelar</button>
                    <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 transition">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Estrutura Principal da Aplicação (Após Login) -->
    <div id="app-container" class="screen hidden md:flex">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-gray-800 text-gray-300 flex flex-col p-4 fixed h-full z-20">
            <div class="text-white h-10 mb-8 flex items-center justify-center">
                <!-- LOGO DA AMAZON -->
                <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="h-10 text-white sidebar-icon-only hidden"><title>Amazon</title><path d="M16.53,10.85c-2.73-1.43-5.2-2.33-8.89-2.33-4.2,0-6.52,1.23-6.52,3.94,0,2.37,1.49,3.48,4.17,4.68,2.71,1.22,4.8,2.16,4.8,4.8,0,2.56-2.12,4.12-5.46,4.12-4.1,0-6.49-1.58-8.5-3.65l2.76-3.4c1.43,1.43,2.94,2.3,4.9,2.3,2.08,0,3.3-1.08,3.3-2.69,0-2.22-1.3-3.16-4.32-4.47-3.3-1.46-5.1-2.4-5.1-5.12,0-2.8,2.37-4.5,6-4.5,3.16,0,5.55,1.15,7.39,3.16Z" fill="currentColor"/></svg>
                 <svg class="h-8 text-white sidebar-text" viewBox="0 0 1024 1024" fill="currentColor" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M512 512m-448 0a448 448 0 1 0 896 0 448 448 0 1 0-896 0Z" fill="#F3A847" ></path><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64z m183.2 607.2c-7.4 8.6-17.8 13.2-31.2 13.2-12.8 0-23.4-3.6-31.4-11-8-7.4-12-17-12-28.4 0-11.4 4-20.8 12.2-28.2 8.2-7.4 18.8-11.2 31.8-11.2 12.4 0 22.8 3.4 31 10.4l-18.6-94.8H398.6L380 619.6c8.4 7 19.2 10.4 32.2 10.4 13.4 0 24.4-3.8 32.6-11.4 8.2-7.6 12.4-17.6 12.4-29.6 0-11.4-3.8-20.8-11.4-28.2-7.6-7.4-18-11-31.4-11-13.6 0-25.2 4-34.8 11.8l17.4 88.8H295.4l42.4-215.8c22-14.2 47.6-21.4 76.8-21.4 28.6 0 53.4 7 74.6 21 21.2 14 31.8 34.8 31.8 62.4 0 16.4-3.2 31.2-9.6 44.4-6.4 13.2-15.8 23.8-28.2 2-10.4-3.6-18.6-6.8-24.4-9.6l-33.6 171z" fill="#232F3E"  ></path><path d="M722.8 668.2c-50.2 31-105.8 47.4-162.2 47.4s-112.2-16.4-162.4-49.2c-6.8-4.4-10.2-12.8-8.2-21 2-8.2 8.6-14 17-14h300.2c8.2 0 15 5.8 17 14 2 8.4-1.4 16.8-8.4 21.2z" fill="#FFFFFF" ></path></svg>
                <span class="ml-3 text-2xl font-bold text-white sidebar-text">Seller Dash</span>
            </div>
            <nav class="flex-grow flex flex-col space-y-2">
                <a href="#dashboard" class="sidebar-link active flex items-center py-3 px-4 rounded-lg hover:bg-gray-700 transition"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg><span class="sidebar-text">Painel Principal</span></a>
                <a href="#orders" class="sidebar-link flex items-center py-3 px-4 rounded-lg hover:bg-gray-700 transition"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg><span class="sidebar-text">Pedidos e Finanças</span></a>
                <a href="#history" class="sidebar-link flex items-center py-3 px-4 rounded-lg hover:bg-gray-700 transition"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span class="sidebar-text">Histórico de Pedidos</span></a>
                <a href="#inventory" class="sidebar-link flex items-center py-3 px-4 rounded-lg hover:bg-gray-700 transition"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg><span class="sidebar-text">Inventário</span></a>
                <a href="#settings" class="sidebar-link flex items-center py-3 px-4 rounded-lg hover:bg-gray-700 transition"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg><span class="sidebar-text">Configurações</span></a>
            </nav>
            <div class="mt-auto pt-4 border-t border-gray-700">
                 <p id="user-email-sidebar" class="text-sm text-center sidebar-text truncate"></p>
                <button id="logout-btn" class="w-full mt-2 bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition flex items-center justify-center"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg><span class="sidebar-text ml-2">Sair</span></button>
                <button id="sidebar-toggle" class="w-full mt-2 text-gray-400 font-semibold py-2 px-4 rounded-lg hover:bg-gray-700 transition flex items-center justify-center">
                    <svg class="w-5 h-5 transform transition-transform duration-300" id="toggle-icon-left" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path></svg>
                    <span class="sidebar-text ml-2">Recolher</span>
                </button>
            </div>
        </aside>

        <!-- Conteúdo Principal -->
        <main id="main-content" class="md:ml-64 flex-1 p-8">
            <!-- View: Painel Principal -->
            <div id="dashboard-view" class="view">
                <h2 class="text-3xl font-bold mb-6 text-gray-900 dark:text-white">Painel Principal</h2>
                <!-- Cards de Métricas -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md"><h3 class="text-gray-500 dark:text-gray-400 font-medium">Saldo Atual</h3><p id="balance" class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mt-2">R$ 0,00</p></div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md"><h3 class="text-gray-500 dark:text-gray-400 font-medium">Lucro Total</h3><p id="total-profit" class="text-3xl font-bold text-green-500 mt-2">R$ 0,00</p></div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md"><h3 class="text-gray-500 dark:text-gray-400 font-medium">Margem de Lucro</h3><p id="profit-margin" class="text-3xl font-bold text-sky-500 mt-2">0.00%</p></div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md space-y-2">
                        <div><h3 class="text-gray-500 dark:text-gray-400 font-medium">Dia de Pico</h3><p id="peak-day" class="text-lg font-bold text-gray-800 dark:text-gray-200">N/A</p></div>
                        <div><h3 class="text-gray-500 dark:text-gray-400 font-medium">Mês de Pico</h3><p id="peak-month" class="text-lg font-bold text-gray-800 dark:text-gray-200">N/A</p></div>
                    </div>
                </div>

                <!-- Seção de Gráficos Interativos -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                        <h3 class="text-xl font-bold mb-4 md:mb-0 text-gray-900 dark:text-white">Análise Visual</h3>
                        <div class="flex items-center space-x-4">
                            <select id="chart-data-select" class="bg-gray-100 dark:bg-gray-700 rounded-lg p-2 border dark:border-gray-600">
                                <option value="receita">Receitas</option>
                                <option value="despesa">Despesas</option>
                            </select>
                             <select id="chart-type-select" class="bg-gray-100 dark:bg-gray-700 rounded-lg p-2 border dark:border-gray-600">
                                <option value="line">Linha</option>
                                <option value="pie">Pizza</option>
                                <option value="candlestick">Velas (Diário)</option>
                            </select>
                        </div>
                    </div>
                    <div class="h-96">
                        <canvas id="main-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- View: Pedidos e Finanças (Gerenciador de Transações) -->
            <div id="orders-view" class="view hidden">
                 <h2 class="text-3xl font-bold mb-6 text-gray-900 dark:text-white">Registrar Transação</h2>
                 <div class="grid grid-cols-1">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md h-fit">
                        <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label for="transaction-type" class="block text-gray-700 dark:text-gray-300 font-medium mb-2">Tipo de Transação</label>
                                <select id="transaction-type" class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg border dark:border-gray-600 focus:ring-2 focus:ring-indigo-500">
                                    <option value="receita">Receita (Venda)</option>
                                    <option value="despesa">Despesa (Compra de Estoque)</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label for="order-id" class="block text-gray-700 dark:text-gray-300 font-medium mb-2">ID do Pedido</label>
                                <input type="text" id="order-id" placeholder="Ex: 702-8729906-8581828" pattern="\d{3}-\d{7}-\d{7}" class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg border dark:border-gray-600 focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div class="md:col-span-2">
                                <label for="product-name" class="block text-gray-700 dark:text-gray-300 font-medium mb-2">Nome do Produto/Serviço</label>
                                <input type="text" id="product-name" placeholder="Descrição do item" required class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg border dark:border-gray-600 focus:ring-2 focus:ring-indigo-500">
                            </div>
                             <div>
                                <label for="quantity" class="block text-gray-700 dark:text-gray-300 font-medium mb-2">Quantidade</label>
                                <input type="number" id="quantity" value="1" min="1" required class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg border dark:border-gray-600 focus:ring-2 focus:ring-indigo-500">
                            </div>
                             <div>
                                <label for="amount" class="block text-gray-700 dark:text-gray-300 font-medium mb-2">Valor (R$)</label>
                                <input type="number" step="0.01" id="amount" placeholder="Valor da transação" required class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg border dark:border-gray-600 focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <!-- Campo que muda dependendo do tipo -->
                            <div id="feito-por-field" class="md:col-span-2">
                                <label for="feito-por" class="block text-gray-700 dark:text-gray-300 font-medium mb-2">Feito Por (Comprador)</label>
                                <input type="text" id="feito-por" placeholder="Nome de quem fez o pedido" class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg border dark:border-gray-600 focus:ring-2 focus:ring-indigo-500">
                            </div>
                             <div id="fornecedor-field" class="md:col-span-2 hidden">
                                <label for="fornecedor" class="block text-gray-700 dark:text-gray-300 font-medium mb-2">Fornecedor</label>
                                <input type="text" id="fornecedor" placeholder="Nome do fornecedor" class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg border dark:border-gray-600 focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div class="md:col-span-2">
                                <button type="submit" id="add-transaction-btn" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition flex items-center justify-center"><span class="btn-text">Registrar</span><span class="btn-spinner hidden spinner !h-5 !w-5 !border-2"></span></button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- View: Histórico de Pedidos -->
            <div id="history-view" class="view hidden">
                <h2 class="text-3xl font-bold mb-6 text-gray-900 dark:text-white">Histórico de Pedidos</h2>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md">
                    <!-- Controles de Filtro -->
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-4 items-end">
                        <div class="md:col-span-2">
                            <label for="search-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Buscar</label>
                            <input type="text" id="search-input" placeholder="Procure por ID, produto, valor..." class="mt-1 w-full p-2 bg-gray-100 dark:bg-gray-700 rounded-lg border dark:border-gray-600">
                        </div>
                        <div>
                            <label for="date-start" class="block text-sm font-medium text-gray-700 dark:text-gray-300">De</label>
                            <input type="date" id="date-start" class="mt-1 w-full p-2 bg-gray-100 dark:bg-gray-700 rounded-lg border dark:border-gray-600 text-gray-500 dark:text-gray-300">
                        </div>
                        <div>
                            <label for="date-end" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Até</label>
                            <input type="date" id="date-end" class="mt-1 w-full p-2 bg-gray-100 dark:bg-gray-700 rounded-lg border dark:border-gray-600 text-gray-500 dark:text-gray-300">
                        </div>
                         <div>
                            <label for="results-per-page" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Por Página</label>
                            <select id="results-per-page" class="mt-1 w-full p-2 bg-gray-100 dark:bg-gray-700 rounded-lg border dark:border-gray-600">
                                <option>10</option>
                                <option>25</option>
                                <option>50</option>
                            </select>
                        </div>
                    </div>
                    <!-- Tabela -->
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-100 dark:bg-gray-700">
                                <tr>
                                    <th class="p-3">ID do Pedido</th>
                                    <th class="p-3">Produto</th>
                                    <th class="p-3">Qtd.</th>
                                    <th class="p-3">Valor (R$)</th>
                                    <th class="p-3">Data e Hora</th>
                                    <th class="p-3">Feito Por</th>
                                    <th class="p-3">Fornecedor</th>
                                    <th class="p-3">Tipo</th>
                                    <th class="p-3">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body">
                                <!-- Linhas da tabela serão inseridas aqui -->
                            </tbody>
                        </table>
                        <p id="no-history-msg" class="text-gray-500 dark:text-gray-400 text-center py-10 hidden">Nenhum pedido registrado.</p>
                    </div>
                    <!-- Controles de Paginação -->
                    <div id="pagination-controls" class="flex justify-between items-center mt-4">
                        <span id="page-info"></span>
                        <div>
                            <button id="prev-page-btn" class="bg-gray-200 dark:bg-gray-600 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 disabled:opacity-50">Anterior</button>
                            <button id="next-page-btn" class="bg-gray-200 dark:bg-gray-600 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 disabled:opacity-50 ml-2">Próxima</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- View: Inventário -->
            <div id="inventory-view" class="view hidden">
                 <h2 class="text-3xl font-bold mb-6 text-gray-900 dark:text-white">Controle de Inventário</h2>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md">
                     <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-100 dark:bg-gray-700">
                                <tr>
                                    <th class="p-3">Produto</th>
                                    <th class="p-3">Estoque Atual</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-table-body">
                                <!-- Linhas da tabela serão inseridas aqui -->
                            </tbody>
                        </table>
                        <p id="no-inventory-msg" class="text-gray-500 dark:text-gray-400 text-center py-10 hidden">Nenhum produto no inventário. Registre compras de estoque.</p>
                    </div>
                </div>
            </div>
            
            <!-- View: Configurações -->
            <div id="settings-view" class="view hidden">
                <h2 class="text-3xl font-bold mb-6 text-gray-900 dark:text-white">Configurações</h2>
                <div class="space-y-8 max-w-2xl">
                    <!-- Tema -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md">
                        <h3 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">Aparência</h3>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-700 dark:text-gray-300">Modo Escuro</span>
                            <button id="theme-toggle" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-gray-200 dark:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-offset-gray-800">
                                <span id="theme-toggle-handle" class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform"></span>
                            </button>
                        </div>
                    </div>
                    <!-- Alterar Nome de Exibição -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md">
                        <h3 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">Alterar Nome de Exibição</h3>
                        <form id="change-display-name-form" class="space-y-4">
                            <div>
                                <label for="new-display-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Novo Nome</label>
                                <input type="text" id="new-display-name" required class="mt-1 w-full p-2 bg-gray-100 dark:bg-gray-700 rounded-lg border dark:border-gray-600">
                            </div>
                            <div>
                                <label for="current-password-for-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Senha Atual (para confirmação)</label>
                                <input type="password" id="current-password-for-name" required class="mt-1 w-full p-2 bg-gray-100 dark:bg-gray-700 rounded-lg border dark:border-gray-600">
                            </div>
                            <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Salvar Novo Nome</button>
                        </form>
                    </div>
                    <!-- Alterar Senha -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md">
                        <h3 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">Alterar Senha</h3>
                        <form id="change-password-form" class="space-y-4">
                            <div>
                                <label for="current-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Senha Atual</label>
                                <input type="password" id="current-password" required class="mt-1 w-full p-2 bg-gray-100 dark:bg-gray-700 rounded-lg border dark:border-gray-600">
                            </div>
                            <div>
                                <label for="new-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nova Senha</label>
                                <input type="password" id="new-password" minlength="6" required class="mt-1 w-full p-2 bg-gray-100 dark:bg-gray-700 rounded-lg border dark:border-gray-600">
                            </div>
                            <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Salvar Nova Senha</button>
                        </form>
                    </div>
                </div>
            </div>
            
        </main>
    </div>
    
    <script type="module">
        // --- ELEMENTOS DO DOM ---
        const dom = {
            html: document.documentElement,
            loadingScreen: document.getElementById('loading-screen'),
            loadingMessage: document.getElementById('loading-message'),
            authScreen: document.getElementById('auth-screen'),
            appContainer: document.getElementById('app-container'),
            loginForm: document.getElementById('login-form'),
            registerForm: document.getElementById('register-form'),
            showLoginBtn: document.getElementById('show-login-btn'),
            showRegisterBtn: document.getElementById('show-register-btn'),
            authError: document.getElementById('auth-error'),
            userEmailSidebar: document.getElementById('user-email-sidebar'),
            logoutBtn: document.getElementById('logout-btn'),
            sidebar: document.getElementById('sidebar'),
            mainContent: document.getElementById('main-content'),
            sidebarToggle: document.getElementById('sidebar-toggle'),
            transactionForm: document.getElementById('transaction-form'),
            transactionTypeSelect: document.getElementById('transaction-type'),
            feitoPorField: document.getElementById('feito-por-field'),
            fornecedorField: document.getElementById('fornecedor-field'),
            historyTableBody: document.getElementById('history-table-body'),
            noHistoryMsg: document.getElementById('no-history-msg'),
            inventoryTableBody: document.getElementById('inventory-table-body'),
            noInventoryMsg: document.getElementById('no-inventory-msg'),
            balanceDisplay: document.getElementById('balance'),
            totalProfitDisplay: document.getElementById('total-profit'),
            profitMarginDisplay: document.getElementById('profit-margin'),
            peakDayDisplay: document.getElementById('peak-day'),
            peakMonthDisplay: document.getElementById('peak-month'),
            chartDataSelect: document.getElementById('chart-data-select'),
            chartTypeSelect: document.getElementById('chart-type-select'),
            mainChartCanvas: document.getElementById('main-chart'),
            expenseModal: document.getElementById('expense-modal'),
            expenseModalForm: document.getElementById('expense-modal-form'),
            cancelExpenseBtn: document.getElementById('cancel-expense-btn'),
            modalOrderId: document.getElementById('modal-order-id'),
            modalProductName: document.getElementById('modal-product-name'),
            editModal: document.getElementById('edit-modal'),
            editModalForm: document.getElementById('edit-modal-form'),
            cancelEditBtn: document.getElementById('cancel-edit-btn'),
            searchInput: document.getElementById('search-input'),
            dateStartInput: document.getElementById('date-start'),
            dateEndInput: document.getElementById('date-end'),
            resultsPerPageSelect: document.getElementById('results-per-page'),
            paginationControls: document.getElementById('pagination-controls'),
            pageInfo: document.getElementById('page-info'),
            prevPageBtn: document.getElementById('prev-page-btn'),
            nextPageBtn: document.getElementById('next-page-btn'),
            themeToggle: document.getElementById('theme-toggle'),
            themeToggleHandle: document.getElementById('theme-toggle-handle'),
            changeDisplayNameForm: document.getElementById('change-display-name-form'),
            changePasswordForm: document.getElementById('change-password-form'),
            toast: document.getElementById('toast'),
        };

        // --- ESTADO DA APLICAÇÃO ---
        let state = {
            githubConfig: { user: 'Alekkzsx', repo: 'dash-ongoing', token: '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' },
            fullData: { users: [], transactions: {} },
            fileSha: null,
            loggedInUser: null,
            mainChart: null,
            pendingRevenueTransaction: null,
            history: { currentPage: 1, itemsPerPage: 10, searchQuery: '', startDate: '', endDate: '' },
        };

        // --- INICIALIZAÇÃO E FLUXO PRINCIPAL ---
        function init() {
            setupEventListeners();
            setupRouting();
            
            showScreen('loading');
            dom.loadingMessage.textContent = 'Carregando usuários...';

            loadDataAndStartApp();
        }

        async function loadDataAndStartApp() {
             try {
                await loadDataFromGithub();
                state.loggedInUser = sessionStorage.getItem('loggedInUser');
                
                if (state.loggedInUser && state.fullData.users.some(u => u.email === state.loggedInUser)) {
                    enterDashboard();
                } else {
                    sessionStorage.removeItem('loggedInUser');
                    state.loggedInUser = null;
                    showScreen('auth');
                }
            } catch (error) {
                console.error("Erro Crítico na Inicialização:", error);
                showToast(`Erro na inicialização: ${error.message}`, 'error');
                showScreen('auth'); 
            }
        }
        
        // --- LÓGICA DE ROTEAMENTO E EVENTOS ---
        function setupRouting() {
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('href').substring(1) + '-view';
                    document.querySelectorAll('.view').forEach(view => view.classList.add('hidden'));
                    const targetView = document.getElementById(targetId);
                    if(targetView) targetView.classList.remove('hidden');
                    sidebarLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                });
            });
        }
        
        function setupEventListeners() {
            dom.chartTypeSelect.addEventListener('change', updateMainChart);
            dom.chartDataSelect.addEventListener('change', updateMainChart);
            dom.showLoginBtn.addEventListener('click', () => toggleAuthForms(true));
            dom.showRegisterBtn.addEventListener('click', () => toggleAuthForms(false));
            dom.loginForm.addEventListener('submit', handleLogin);
            dom.registerForm.addEventListener('submit', handleRegister);
            dom.logoutBtn.addEventListener('click', handleLogout);
            dom.transactionForm.addEventListener('submit', handleTransactionSubmit);
            dom.expenseModalForm.addEventListener('submit', handleCostSubmit);
            dom.cancelExpenseBtn.addEventListener('click', () => dom.expenseModal.classList.add('hidden'));
            dom.transactionTypeSelect.addEventListener('change', toggleTransactionFields);

            dom.searchInput.addEventListener('input', () => { state.history.searchQuery = dom.searchInput.value; state.history.currentPage = 1; updateHistoryView(); });
            dom.dateStartInput.addEventListener('change', () => { state.history.startDate = dom.dateStartInput.value; state.history.currentPage = 1; updateHistoryView(); });
            dom.dateEndInput.addEventListener('change', () => { state.history.endDate = dom.dateEndInput.value; state.history.currentPage = 1; updateHistoryView(); });
            dom.resultsPerPageSelect.addEventListener('change', () => { state.history.itemsPerPage = parseInt(dom.resultsPerPageSelect.value); state.history.currentPage = 1; updateHistoryView(); });
            dom.prevPageBtn.addEventListener('click', () => { if (state.history.currentPage > 1) { state.history.currentPage--; updateHistoryView(); } });
            dom.nextPageBtn.addEventListener('click', () => { state.history.currentPage++; updateHistoryView(); });
            
            dom.cancelEditBtn.addEventListener('click', () => dom.editModal.classList.add('hidden'));
            dom.editModalForm.addEventListener('submit', handleUpdateTransaction);
            
            dom.historyTableBody.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-btn');
                const deleteBtn = e.target.closest('.delete-btn');
                if (editBtn) showEditModal(editBtn.dataset.id);
                if (deleteBtn) handleDeleteTransaction(deleteBtn.dataset.id);
            });
            
            dom.sidebarToggle.addEventListener('click', toggleSidebar);
            dom.themeToggle.addEventListener('click', toggleTheme);
            dom.changeDisplayNameForm.addEventListener('submit', handleDisplayNameChange);
            dom.changePasswordForm.addEventListener('submit', handlePasswordChange);
        }

        function enterDashboard() {
            const user = state.fullData.users.find(u => u.email === state.loggedInUser);
            dom.userEmailSidebar.textContent = user?.displayName || state.loggedInUser;
            updateAllUI();
            showScreen('app');
        }

        // --- LÓGICA DE UI ---
        function toggleTransactionFields() {
            const type = dom.transactionTypeSelect.value;
            const btnText = dom.transactionForm.querySelector('.btn-text');
            if (type === 'receita') {
                dom.feitoPorField.classList.remove('hidden');
                dom.fornecedorField.classList.add('hidden');
                btnText.textContent = 'Registrar Venda e Adicionar Custo';
                document.getElementById('order-id').required = true;
                document.getElementById('feito-por').required = true;
                document.getElementById('fornecedor').required = false;
            } else {
                dom.feitoPorField.classList.add('hidden');
                dom.fornecedorField.classList.remove('hidden');
                btnText.textContent = 'Registrar Despesa';
                document.getElementById('order-id').required = false;
                document.getElementById('feito-por').required = false;
                document.getElementById('fornecedor').required = true;
            }
        }
        
        function toggleSidebar() {
            dom.sidebar.classList.toggle('w-64');
            dom.sidebar.classList.toggle('w-20');
            dom.mainContent.classList.toggle('md:ml-64');
            dom.mainContent.classList.toggle('md:ml-20');
            document.querySelectorAll('.sidebar-text').forEach(el => el.classList.toggle('hidden'));
            document.querySelectorAll('.sidebar-icon-only').forEach(el => el.classList.toggle('hidden'));
            const icon = document.getElementById('toggle-icon-left');
            icon.classList.toggle('rotate-180');
        }
        
        function toggleTheme() {
            dom.html.classList.toggle('dark');
            const isDark = dom.html.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            dom.themeToggleHandle.classList.toggle('translate-x-6', isDark);
            dom.themeToggleHandle.classList.toggle('translate-x-1', !isDark);
        }

        function showToast(message, type = 'success') {
            dom.toast.textContent = message;
            dom.toast.className = 'bg-white dark:bg-gray-800 text-gray-900 dark:text-white'; // Reset
            if (type === 'success') {
                dom.toast.classList.add('bg-green-500', 'text-white');
            } else if (type === 'error') {
                dom.toast.classList.add('bg-red-500', 'text-white');
            }
            dom.toast.classList.add('show');
            setTimeout(() => {
                dom.toast.classList.remove('show');
            }, 3000);
        }

        // --- LÓGICA DE DADOS E CÁLCULOS ---
        
        function calculateMetrics(transactions) {
            if (!transactions || transactions.length === 0) return { balance: 0, totalRevenue: 0, totalExpense: 0, totalProfit: 0, profitMargin: 0, peakDay: { date: 'N/A', amount: 0 }, peakMonth: { date: 'N/A', amount: 0 } };
            let totalRevenue = 0, totalExpense = 0;
            const dailyRevenue = {}, monthlyRevenue = {};
            transactions.forEach(t => {
                if (t.type === 'receita') {
                    totalRevenue += t.amount;
                    if (t.dateTime) {
                        const date = t.dateTime.substring(0, 10);
                        dailyRevenue[date] = (dailyRevenue[date] || 0) + t.amount;
                        const month = date.substring(0, 7);
                        monthlyRevenue[month] = (monthlyRevenue[month] || 0) + t.amount;
                    }
                } else {
                    totalExpense += t.amount;
                }
            });
            const findPeak = (data) => Object.entries(data).reduce((peak, [date, amount]) => amount > peak.amount ? { date, amount } : peak, { date: 'N/A', amount: 0 });
            const totalProfit = totalRevenue - totalExpense;
            const profitMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;
            return { balance: totalProfit, totalRevenue, totalExpense, totalProfit, profitMargin, peakDay: findPeak(dailyRevenue), peakMonth: findPeak(monthlyRevenue) };
        }
        
        function getFilteredTransactions() {
            const userTransactions = state.fullData.transactions[state.loggedInUser] || [];
            const { searchQuery, startDate, endDate } = state.history;
            return userTransactions.filter(t => {
                const searchMatch = !searchQuery || Object.values(t).some(val => String(val).toLowerCase().includes(searchQuery.toLowerCase()));
                const date = t.dateTime ? t.dateTime.substring(0, 10) : '';
                const startMatch = !startDate || (date && date >= startDate);
                const endMatch = !endDate || (date && date <= endDate);
                return searchMatch && startMatch && endMatch;
            });
        }
        
        function calculateInventory() {
            const inventory = {};
            const transactions = state.fullData.transactions[state.loggedInUser] || [];
            transactions.forEach(t => {
                if (!t.productName) return;
                const productName = t.productName.toLowerCase().trim();
                
                if (t.type === 'despesa' && (t.category === 'custo-produto' || t.category === 'compra-estoque' || t.category === 'custo-geral')) {
                    inventory[productName] = (inventory[productName] || 0) + t.quantity;
                } else if (t.type === 'receita') {
                    inventory[productName] = (inventory[productName] || 0) - t.quantity;
                }
            });
            return Object.entries(inventory).sort((a,b) => a[0].localeCompare(b[0]));
        }

        // --- LÓGICA DOS GRÁFICOS ---
        function updateMainChart() {
            const chartType = dom.chartTypeSelect.value;
            const dataType = dom.chartDataSelect.value;
            const userTransactions = state.fullData.transactions[state.loggedInUser] || [];
            if (state.mainChart) state.mainChart.destroy();
            const ctx = dom.mainChartCanvas.getContext('2d');
            let config;
            dom.chartDataSelect.disabled = false;
            switch(chartType) {
                case 'line': config = getLineChartConfig(userTransactions, dataType); break;
                case 'pie': config = getPieChartConfig(userTransactions, dataType); break;
                case 'candlestick':
                    config = getCandlestickChartConfig(userTransactions);
                    dom.chartDataSelect.value = 'receita';
                    dom.chartDataSelect.disabled = true;
                    break;
            }
            if(config) state.mainChart = new Chart(ctx, config);
        }
        function getLineChartConfig(transactions, type) {
             const dataByType = transactions.filter(t => t.type === type && t.dateTime).sort((a,b) => new Date(a.dateTime) - new Date(b.dateTime));
            return {
                type: 'line', data: { labels: dataByType.map(t => t.dateTime), datasets: [{ label: type === 'receita' ? 'Receita' : 'Despesa', data: dataByType.map(t => t.amount), borderColor: type === 'receita' ? '#22c55e' : '#ef4444', tension: 0.1 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day' } } } }
            };
        }
        function getPieChartConfig(transactions, type) {
            const dataByCategory = transactions.filter(t => t.type === type).reduce((acc, t) => { acc[t.category] = (acc[t.category] || 0) + t.amount; return acc; }, {});
            return {
                type: 'pie', data: { labels: Object.keys(dataByCategory), datasets: [{ data: Object.values(dataByCategory), backgroundColor: ['#ef4444', '#3b82f6', '#f59e0b', '#10b981', '#8b5cf6', '#f97316', '#6b7280'] }] },
                options: { responsive: true, maintainAspectRatio: false }
            };
        }
        function getCandlestickChartConfig(transactions) {
            const revenues = transactions.filter(t => t.type === 'receita' && t.dateTime);
            const dataByDay = revenues.reduce((acc, t) => { const day = new Date(t.dateTime).setHours(0,0,0,0); if (!acc[day]) acc[day] = []; acc[day].push(t.amount); return acc; }, {});
            const chartData = Object.entries(dataByDay).map(([day, amounts]) => ({ x: Number(day), o: amounts[0], h: Math.max(...amounts), l: Math.min(...amounts), c: amounts[amounts.length - 1] })).sort((a, b) => a.x - b.x);
            return {
                type: 'candlestick', data: { datasets: [{ label: 'Receita Diária', data: chartData }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day' } } } }
            };
        }

        // --- ATUALIZAÇÃO DA UI ---
        function updateAllUI() {
            const allTransactions = state.fullData.transactions[state.loggedInUser] || [];
            const metrics = calculateMetrics(allTransactions);
            dom.balanceDisplay.textContent = `R$ ${metrics.balance.toFixed(2)}`;
            dom.totalProfitDisplay.textContent = `R$ ${metrics.totalProfit.toFixed(2)}`;
            dom.profitMarginDisplay.textContent = `${metrics.profitMargin.toFixed(2)}%`;
            dom.peakDayDisplay.textContent = `${metrics.peakDay.date} (R$ ${metrics.peakDay.amount.toFixed(2)})`;
            dom.peakMonthDisplay.textContent = `${metrics.peakMonth.date} (R$ ${metrics.peakMonth.amount.toFixed(2)})`;
            updateMainChart();
            updateHistoryView();
            updateInventoryView();
        }
        
        function showScreen(screenName) {
            dom.loadingScreen.classList.add('hidden');
            dom.authScreen.classList.add('hidden');
            dom.appContainer.classList.add('hidden');
            if (screenName === 'loading') dom.loadingScreen.classList.remove('hidden');
            else if (screenName === 'auth') dom.authScreen.classList.remove('hidden');
            else if (screenName === 'app') dom.appContainer.classList.remove('hidden');
        }
        
        function updateHistoryView() {
            const filtered = getFilteredTransactions();
            const sorted = filtered.sort((a, b) => {
                const orderIdA = a.orderId || 'zzz';
                const orderIdB = b.orderId || 'zzz';
                if (orderIdA < orderIdB) return -1;
                if (orderIdA > orderIdB) return 1;
                if (a.type === 'receita' && b.type === 'despesa') return -1;
                if (a.type === 'despesa' && b.type === 'receita') return 1;
                return new Date(b.dateTime) - new Date(a.dateTime);
            });
            const { currentPage, itemsPerPage } = state.history;
            const totalPages = Math.ceil(sorted.length / itemsPerPage);
            const paginatedItems = sorted.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
            renderHistoryTable(paginatedItems);
            renderPaginationControls(sorted.length, totalPages);
        }
        
        function updateInventoryView() {
            const inventory = calculateInventory();
            dom.inventoryTableBody.innerHTML = '';
            dom.noInventoryMsg.classList.toggle('hidden', inventory.length > 0);
            inventory.forEach(([productName, quantity]) => {
                const el = document.createElement('tr');
                el.className = 'bg-white dark:bg-gray-800 border-b dark:border-gray-700';
                el.innerHTML = `<td class="p-3 capitalize">${productName}</td><td class="p-3 font-bold">${quantity}</td>`;
                dom.inventoryTableBody.appendChild(el);
            });
        }

        function renderHistoryTable(transactions) {
            dom.historyTableBody.innerHTML = '';
            dom.noHistoryMsg.classList.toggle('hidden', transactions.length > 0);
            transactions.forEach(t => {
                const isIncome = t.type === 'receita';
                const el = document.createElement('tr');
                el.className = 'bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600';
                el.innerHTML = `
                    <td class="p-3">${t.orderId || '-'}</td>
                    <td class="p-3">${t.productName}</td>
                    <td class="p-3">${t.quantity}</td>
                    <td class="p-3 font-semibold ${isIncome ? 'text-green-500' : 'text-red-500'}">${t.amount.toFixed(2)}</td>
                    <td class="p-3">${t.dateTime ? new Date(t.dateTime).toLocaleString('pt-BR') : 'N/A'}</td>
                    <td class="p-3">${t.feitoPor || '-'}</td>
                    <td class="p-3">${t.fornecedor || '-'}</td>
                    <td class="p-3">
                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${isIncome ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}">
                            ${isIncome ? 'Receita' : 'Despesa'}
                        </span>
                    </td>
                    <td class="p-3 flex space-x-2">
                        <button data-id="${t.id}" class="edit-btn p-1 text-blue-600 hover:text-blue-800"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg></button>
                        <button data-id="${t.id}" class="delete-btn p-1 text-red-600 hover:text-red-800"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg></button>
                    </td>`;
                dom.historyTableBody.appendChild(el);
            });
        }

        function renderPaginationControls(totalItems, totalPages) {
            if (totalItems === 0) { dom.paginationControls.classList.add('hidden'); return; }
            dom.paginationControls.classList.remove('hidden');
            const { currentPage, itemsPerPage } = state.history;
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalItems);
            dom.pageInfo.textContent = `Mostrando ${startItem}-${endItem} de ${totalItems}`;
            dom.prevPageBtn.disabled = currentPage === 1;
            dom.nextPageBtn.disabled = currentPage >= totalPages;
        }
        
        async function hashPassword(password) { const encoder = new TextEncoder(); const data = encoder.encode(password); const hashBuffer = await crypto.subtle.digest('SHA-256', data); const hashArray = Array.from(new Uint8Array(hashBuffer)); return hashArray.map(b => b.toString(16).padStart(2, '0')).join(''); }
        
        // --- ABSTRAÇÃO DA API DO GITHUB ---
        const GitHubService = {
            async request(endpoint, options = {}) {
                const { user, repo, token } = state.githubConfig;
                if (!token) throw new Error('GitHub Token não configurado.');
                const url = `https://api.github.com/repos/${user}/${repo}/contents/${endpoint}`;
                const headers = new Headers({ 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json', 'X-GitHub-Api-Version': '2022-11-28' });
                const response = await fetch(url, { headers, ...options });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Erro ${response.status}`);
                }
                return response.json();
            },
            async getFile(path) {
                try {
                    const data = await this.request(path);
                    return { content: JSON.parse(atob(data.content)), sha: data.sha };
                } catch (error) {
                    if (error.message.includes("Not Found")) {
                        return { content: null, sha: null };
                    }
                    throw error;
                }
            },
            async createFile(path, content, message) {
                const contentEncoded = btoa(JSON.stringify(content, null, 2));
                const body = { message, content: contentEncoded };
                return this.request(path, { method: 'PUT', body: JSON.stringify(body) });
            },
            async updateFile(path, content, sha, message) {
                const contentEncoded = btoa(JSON.stringify(content, null, 2));
                 const body = { message, content: contentEncoded, sha };
                return this.request(path, { method: 'PUT', body: JSON.stringify(body) });
            }
        };

        // --- LÓGICA DE MANIPULAÇÃO DE DADOS ---
         async function loadDataFromGithub() {
            try {
                const data = await GitHubService.getFile('data.json');
                if (data.content) {
                    state.fullData = data.content;
                    state.fileSha = data.sha;
                } else {
                    state.fullData = { users: [], transactions: {} };
                    state.fileSha = null;
                }
            } catch (error) {
                dom.loadingMessage.innerHTML = `<p class="text-red-500 font-bold">Falha ao carregar dados!</p><p class="text-sm">${error.message}</p><p class="text-xs mt-2">Verifique seu token de acesso no código ou a conexão.</p>`;
                throw error;
            }
        }

        async function saveData() {
            try {
                const data = await GitHubService.updateFile('data.json', state.fullData, state.fileSha, `Atualiza dados - ${new Date().toISOString()}`);
                state.fileSha = data.content.sha;
                return true;
            } catch (error) {
                showToast(`Erro ao salvar no GitHub: ${error.message}`, 'error');
                return false;
            }
        }
        
        // --- HANDLERS DE EVENTOS ---
        function toggleAuthForms(showLogin) { 
            dom.authError.textContent = ''; 
            dom.loginForm.classList.toggle('hidden', !showLogin); 
            dom.registerForm.classList.toggle('hidden', showLogin); 
            dom.showLoginBtn.classList.toggle('text-indigo-600', showLogin); 
            dom.showLoginBtn.classList.toggle('border-indigo-600', showLogin); 
            dom.showRegisterBtn.classList.toggle('text-indigo-600', !showLogin); 
            dom.showRegisterBtn.classList.toggle('border-indigo-600', !showLogin); 
        }

        async function handleLogin(e) {
            e.preventDefault(); 
            dom.authError.textContent = ''; 
            const email = dom.loginForm['login-email'].value; 
            const password = dom.loginForm['login-password'].value; 
            const passwordHash = await hashPassword(password); 
            const user = state.fullData.users.find(u => u.email === email && u.passwordHash === passwordHash); 
            if (user) { 
                state.loggedInUser = user.email; 
                sessionStorage.setItem('loggedInUser', state.loggedInUser); 
                enterDashboard(); 
            } else { 
                dom.authError.textContent = 'Email ou senha inválidos.'; 
            }
        }

        async function handleRegister(e) { 
            e.preventDefault(); 
            dom.authError.textContent = ''; 
            const email = dom.registerForm['register-email'].value; 
            const password = dom.registerForm['register-password'].value; 
            if (state.fullData.users.some(u => u.email === email)) { 
                dom.authError.textContent = 'Este email já está cadastrado.'; 
                return; 
            } 
            const passwordHash = await hashPassword(password); 
            state.fullData.users.push({ email, passwordHash, displayName: '' }); 
            if (!state.fullData.transactions[email]) state.fullData.transactions[email] = []; 
            const success = await saveData(); 
            if (success) { 
                state.loggedInUser = email; 
                sessionStorage.setItem('loggedInUser', state.loggedInUser); 
                enterDashboard(); 
            } else { 
                state.fullData.users.pop(); 
                delete state.fullData.transactions[email]; 
            } 
        }
        function handleLogout() { 
            state.loggedInUser = null; 
            sessionStorage.removeItem('loggedInUser'); 
            showScreen('auth'); 
        }
        
        async function handleTransactionSubmit(e) {
            e.preventDefault();
            const type = dom.transactionTypeSelect.value;
            if (type === 'receita') await handleRevenueSubmit();
            else await handleSimpleExpenseSubmit();
        }

        async function handleRevenueSubmit() {
            const btn = dom.transactionForm.querySelector('button[type="submit"]');
            const btnText = btn.querySelector('.btn-text');
            const btnSpinner = btn.querySelector('.btn-spinner');
            const orderId = dom.transactionForm['order-id'].value;
            const userTransactions = state.fullData.transactions[state.loggedInUser] || [];
            if (userTransactions.some(t => t.orderId === orderId && t.type === 'receita')) {
                alert('ID já existente para este tipo de transação.');
                return;
            }
            btn.disabled = true; btnText.classList.add('hidden'); btnSpinner.classList.remove('hidden');
            const revenueTransaction = { id: crypto.randomUUID(), orderId, productName: dom.transactionForm['product-name'].value, quantity: parseInt(dom.transactionForm['quantity'].value), amount: parseFloat(dom.transactionForm['amount'].value), feitoPor: dom.transactionForm['feito-por'].value, fornecedor: '', dateTime: new Date().toISOString(), type: 'receita', category: 'venda-produto' };
            if (!state.fullData.transactions[state.loggedInUser]) state.fullData.transactions[state.loggedInUser] = [];
            state.fullData.transactions[state.loggedInUser].push(revenueTransaction);
            if (await saveData()) { dom.transactionForm.reset(); toggleTransactionFields(); state.pendingRevenueTransaction = revenueTransaction; showExpenseModal(); } else { state.fullData.transactions[state.loggedInUser].pop(); }
            btn.disabled = false; btnText.classList.remove('hidden'); btnSpinner.classList.add('hidden');
        }

        async function handleSimpleExpenseSubmit() {
            const btn = dom.transactionForm.querySelector('button[type="submit"]');
            const btnText = btn.querySelector('.btn-text');
            const btnSpinner = btn.querySelector('.btn-spinner');
            const orderId = dom.transactionForm['order-id'].value;
            if (orderId) {
                const userTransactions = state.fullData.transactions[state.loggedInUser] || [];
                if (userTransactions.some(t => t.orderId === orderId && t.type === 'despesa')) {
                    alert('ID já existente para este tipo de transação.');
                    return;
                }
            }
            btn.disabled = true; btnText.classList.add('hidden'); btnSpinner.classList.remove('hidden');
            const expenseTransaction = { id: crypto.randomUUID(), orderId: orderId || 'N/A', productName: dom.transactionForm['product-name'].value, quantity: parseInt(dom.transactionForm['quantity'].value), amount: parseFloat(dom.transactionForm['amount'].value), feitoPor: '', fornecedor: dom.transactionForm['fornecedor'].value, dateTime: new Date().toISOString(), type: 'despesa', category: 'custo-geral' };
            if (!state.fullData.transactions[state.loggedInUser]) state.fullData.transactions[state.loggedInUser] = [];
            state.fullData.transactions[state.loggedInUser].push(expenseTransaction);
            if(await saveData()) { alert('Despesa registrada com sucesso!'); dom.transactionForm.reset(); toggleTransactionFields(); updateAllUI(); } else { state.fullData.transactions[state.loggedInUser].pop(); }
            btn.disabled = false; btnText.classList.remove('hidden'); btnSpinner.classList.add('hidden');
        }

        function showExpenseModal() {
            dom.modalOrderId.textContent = state.pendingRevenueTransaction.orderId;
            dom.modalProductName.textContent = state.pendingRevenueTransaction.productName;
            dom.expenseModal.classList.remove('hidden');
            document.getElementById('expense-amount').focus();
        }

        async function handleCostSubmit(e) {
            e.preventDefault();
            const expenseAmount = parseFloat(document.getElementById('expense-amount').value);
            const fornecedor = document.getElementById('modal-fornecedor').value;
            if (isNaN(expenseAmount) || expenseAmount <= 0) { alert('Por favor, insira um valor de custo válido.'); return; }
            if (!fornecedor) { alert('Por favor, insira o nome do fornecedor.'); return; }
            const userTransactions = state.fullData.transactions[state.loggedInUser] || [];
             if (userTransactions.some(t => t.orderId === state.pendingRevenueTransaction.orderId && t.type === 'despesa')) {
                alert('ID já existente para este tipo de transação.');
                dom.expenseModal.classList.add('hidden');
                dom.expenseModalForm.reset();
                state.pendingRevenueTransaction = null;
                return;
            }
            const expenseTransaction = { ...state.pendingRevenueTransaction, id: crypto.randomUUID(), amount: expenseAmount, feitoPor: '', fornecedor: fornecedor, dateTime: new Date().toISOString(), type: 'despesa', category: 'custo-produto' };
            state.fullData.transactions[state.loggedInUser].push(expenseTransaction);
            if(await saveData()) { alert('Venda e custo registrados com sucesso!'); updateAllUI(); } else { state.fullData.transactions[state.loggedInUser].pop(); }
            dom.expenseModal.classList.add('hidden');
            dom.expenseModalForm.reset();
            state.pendingRevenueTransaction = null;
        }

        function showEditModal(transactionId) {
            const transaction = state.fullData.transactions[state.loggedInUser].find(t => t.id === transactionId);
            if (!transaction) return;
            const form = dom.editModalForm;
            form['edit-id'].value = transaction.id;
            form['edit-order-id'].value = transaction.orderId || '';
            form['edit-product-name'].value = transaction.productName;
            form['edit-quantity'].value = transaction.quantity;
            form['edit-amount'].value = transaction.amount;
            form['edit-feito-por'].value = transaction.feitoPor || '';
            form['edit-fornecedor'].value = transaction.fornecedor || '';
            dom.editModal.classList.remove('hidden');
        }

        async function handleUpdateTransaction(e) {
            e.preventDefault();
            const form = dom.editModalForm;
            const transactionId = form['edit-id'].value;
            const transactionIndex = state.fullData.transactions[state.loggedInUser].findIndex(t => t.id === transactionId);
            if (transactionIndex === -1) return;
            const originalTransaction = { ...state.fullData.transactions[state.loggedInUser][transactionIndex] };
            const updatedTransaction = { ...originalTransaction, orderId: form['edit-order-id'].value, productName: form['edit-product-name'].value, quantity: parseInt(form['edit-quantity'].value), amount: parseFloat(form['edit-amount'].value), feitoPor: form['edit-feito-por'].value, fornecedor: form['edit-fornecedor'].value, };
            state.fullData.transactions[state.loggedInUser][transactionIndex] = updatedTransaction;
            if (await saveData()) { alert('Transação atualizada!'); dom.editModal.classList.add('hidden'); updateAllUI(); } else { state.fullData.transactions[state.loggedInUser][transactionIndex] = originalTransaction; alert('Falha ao atualizar.'); }
        }

        async function handleDeleteTransaction(transactionId) {
            if (!confirm('Tem certeza que deseja excluir esta transação? Esta ação não pode ser desfeita.')) return;
            const originalTransactions = [...state.fullData.transactions[state.loggedInUser]];
            const updatedTransactions = originalTransactions.filter(t => t.id !== transactionId);
            
            if (updatedTransactions.length === originalTransactions.length) {
                showToast('Erro: Transação não encontrada.', 'error');
                return;
            }
            
            state.fullData.transactions[state.loggedInUser] = updatedTransactions;
            if (await saveData()) {
                showToast('Transação excluída com sucesso.', 'success');
                updateAllUI();
            } else {
                state.fullData.transactions[state.loggedInUser] = originalTransactions; // Rollback
                showToast('Falha ao excluir a transação.', 'error');
            }
        }
        
        async function handleDisplayNameChange(e) {
            e.preventDefault();
            const newName = dom.changeDisplayNameForm['new-display-name'].value;
            const password = dom.changeDisplayNameForm['current-password-for-name'].value;
            if (!newName.trim()) { alert("O nome não pode estar em branco."); return; }
            if (!confirm(`Tem certeza que deseja alterar seu nome de exibição para "${newName}"? Seu email de login permanecerá o mesmo.`)) return;
            
            const userIndex = state.fullData.users.findIndex(u => u.email === state.loggedInUser);
            if (userIndex === -1) { alert("Usuário não encontrado."); return; }
            const passwordHash = await hashPassword(password);
            if (state.fullData.users[userIndex].passwordHash !== passwordHash) { alert("Senha atual incorreta."); return; }
            
            const oldName = state.fullData.users[userIndex].displayName;
            state.fullData.users[userIndex].displayName = newName;
            if (await saveData()) {
                dom.userEmailSidebar.textContent = newName;
                alert("Nome de exibição atualizado!");
                dom.changeDisplayNameForm.reset();
            } else {
                state.fullData.users[userIndex].displayName = oldName;
            }
        }

        async function handlePasswordChange(e) {
            e.preventDefault();
            const currentPassword = dom.changePasswordForm['current-password'].value;
            const newPassword = dom.changePasswordForm['new-password'].value;
            const userIndex = state.fullData.users.findIndex(u => u.email === state.loggedInUser);
            if (userIndex === -1) { alert("Usuário não encontrado."); return; }
            const currentPasswordHash = await hashPassword(currentPassword);
            if (state.fullData.users[userIndex].passwordHash !== currentPasswordHash) { alert("Senha atual incorreta."); return; }
            const newPasswordHash = await hashPassword(newPassword);
            const oldPasswordHash = state.fullData.users[userIndex].passwordHash;
            state.fullData.users[userIndex].passwordHash = newPasswordHash;
            if (await saveData()) {
                alert("Senha atualizada com sucesso!");
                dom.changePasswordForm.reset();
            } else {
                state.fullData.users[userIndex].passwordHash = oldPasswordHash;
            }
        }
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

